# CF1696F Tree Recovery

~~这 $O(n^3)$ 暴虐 $O(n^4)$ 标算。~~

这里拜谢 @[monstersqwq](https://www.luogu.com.cn/user/191868)。

我们预判断浅显的错误：$d(i,i)=d(i,j(\ne i))$。

其次，预处理出对于每一个 $x$ 作为根，哪些点的深度（以下记为 $dep$）相同，这里用并查集做到 $O(n^3)$，当然并查集时也可能判无解，记最后每个点为根的并查集为「等深度并查集」。

接下来是主体。

最外层循环，我们枚举 $x\in[2,n]$，表示我们钦定了存在 $(1,x)$ 这条边，接下来的任务就是 $O(n^2)$ 以内的时间构造并判断是否可行。

* * *

**结论：** 钦定了一条边存在后整棵树只有一种形态（或无解）。

**证明：** 我们从已知的边推向未知的边。设 $(x,y)$ 有边，且 $d(x,y)=d(x,z(\ne y))$，则 $(x,z)$ 有边。这样不断拓展，树就唯一。

* * * 

类似上述的证明，我们可以 $O(n^2)$ 求出树的形态。

我们枚举钦定根 $rt\in[1,n]$，然后 $O(n)$ 求出每个点的 $dep$，接下来我们只要用预处理好的等深度并查集 $O(n)$ 判断合法即可。

[已经尽力改美观但是还是很屑的代码](https://codeforces.com/contest/1696/submission/163991829)