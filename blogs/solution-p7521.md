# P7521 [省选联考 2021 B 卷] 取模（看似暴力难证实则高明）

这题评绿显然是恶评啊，都是被数据水而骗分过的人害的。

这有复杂度和正确性证明。

我们将 $a$ 升序排序，即 $a_1\le a_2\le\dots\le a_n$。

如果我们已知了最终答案所取的模数是 $a_x$，则我们可以轻松地 $O(n\log n)$ 计算答案。

* * *

如何轻松？

我们将除了 $a_x$ 的数都 $\bmod\ a_x$ 后存入 $b_1,\dots,b_{n-1}$。

设答案取 $(b_y+b_z)\bmod a_x$，分成两类：

若 $b_y+b_z\ge a_x$，由于 $b_y+b_z\le 2a_x-2$，所以我们选择最大的两个 $b_y,b_z$。

若 $b_y+b_z<a_x$，我们排序后用双指针维护最大值。

* * *

我们**降序**枚举 $a_x$ 为模数，当**当前答案** $ans\ge a_x-1$，则我们输出 $ans$ 直接终止程序，因为接下来答案不可能更优。

当然，如果 $a_x=a_y(x<y)$，则 $a_x$ **没有必要当模数再算一次了**。

**看起来很暴力对吧？但是复杂度是对的。**

* * *

时间复杂度：

我们设可能能成为模数（即这个数在 $\{a\}$ 中之后的数都严格比她大）进行计算的数有：
$$
p_1<p_2<\dots <p_k
$$
$$
a_{p_1}< \dots < a_{p_{c-1}}\le (ans+1)< a_{p_c} \ < \dots <a_{p_k}\quad(*)
$$
其中 $ans$ 为最终答案。

发现 $a_{p_1}\sim a_{p_{c-1}}$ 都不会被算，因为都不大于 $ans+1$。

由于 $ans$ 是最优答案，得到
$$\forall i\in [c,k-2]\cap\mathbb{Z}
,\, (a_{p_i}+a_{p_{i+1}})\bmod a_{p_{i+2}}\le ans
$$
由 $(*)$ 的推论 
$$
a_{p_i}+a_{p_{i+1}}-2a_{p_{i+2}}<0$$
得到
$$
a_{p_i}+a_{p_{i+1}}-a_{p_{i+2}}\le ans
$$
进一步式子变形
$$
(a_{p_{i+2}}-ans)\ge (a_{p_{i+1}}-ans)+(a_{p_i}-ans)\quad(\Delta)
$$
代换 $h_i=a_{p_i}-ans$，由 $(*)$ 有
$$
\forall i\in [c,k]\cap\mathbb{Z},\, h_{i}\ge 2\quad(\text A)
$$
$(\Delta)$ 式子就变成了
$$
h_{i+2}\ge h_{i+1}+h_i\quad(\text B)
$$
结合 $(\text A)(\text B)$ 得到 $\{h\}$ 的**增长速度不小于斐波那契数列的增长速度，即不小于指数级别**。

由于 $a_n\le 10^8$，得到我们真正有计算的模数个数是 $\log 10^8$ 级别的，而一次计算模数的复杂度为 $O(n\log n)$（瓶颈在排序），所以最终复杂度为
$$
O(n\log n\log 10^8)
$$
可以通过 luogu 和 uoj 的测试点，完结撒花。

* * *

[luogu 提交](https://www.luogu.com.cn/record/88016992)

[uoj 提交](https://uoj.ac/submission/585641)