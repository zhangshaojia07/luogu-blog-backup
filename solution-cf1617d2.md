# CF1617D2 Too Many Impostors (hard version)

### Preface

相信读者们都会了 Easy version 的解法了。

这题的**核心想法**在于**通过知道一对 "0+1" 后与另一个数进行询问来确定这个数的值**。

### Analysis

**下文中所有 $m$ 均指代 $\dfrac{n}{3}$。**

发现询问次数限制甚至减少了一半！考虑优化。

1. 先确定一个 $0$ 位置和一个 $1$ 位置，我们用 $m+8$ 次询问之内实现。

2. 再通过 "0+1" 组合确定剩下位置的值，用 $2(m-2)$ 次实现。

我们将人按连续 $3$ 个为一组分组，组分别编号为 $1,2,\dots,m$，我们将每组 $3$ 个都询问一遍，回答记为 $a_1,a_2,\dots,a_m$，由于 $0$ 个数的限制：

$$\exists i\in [1,m],a_i=0\land a_{i\%m+1}=1$$

我们可以通过不超过 $8$ 次知道组 $i,i+1$ 中 $6$ 个值（下文 Function A），而这之中必有 "0+1" 的组合。

我们用这一对 "0+1" 去求其他 $m-2$ 组的值，每一组只要 $2$ 次即可（下文 Function B）。

最后输出 $0$ 的个数和位置即可。

#### Function A

记这 $6$ 个连续的位置分别为 $0,1,\dots,5$，先询问 $(0,1,3)$ 和 $(0,1,4)$。若两个询问答案不等，则 $(0,1)$ 即为 "0+1"；若均为 $0$ 则确定 $(0,1)$ 均为 $0$，再通过询问 $(0,3,4)$ 即可确定 "0+1"；两个询问均为 $1$ 的情况与 $0$ 类似。不懂看代码。

确定了 "0+1" 后再 $4$ 次确定剩下的 $4$ 个位置的值，再通过她们 $4$ 个返回来确定 "0+1" 的 $0,1$ 分别对应关系。

#### Function B

我们以 $a_i=0$ 的情况为例，$a_i=1$ 与之相反对称。

类似于 Function A，记这 $3$ 个连续的位置分别为 $0,1,2$。

设 "0+1" 中 $0,1$ 分别对应 $A,B$。

先询问 $(B,1,2)$ 如果答案为 $1$ 表示 $0$ 的值必定为 $0$，再通过一次询问求出 $1,2$ 的值；如果答案为 $0$，那么 $1,2$ 的值均为 $0$，再通过一次询问求出 $0$ 的值。

### Code

[Link](https://codeforces.com/contest/1617/submission/140167999)