# CF1598E Staircases题解

~~本人 VP 中写挂了 QwQ。~~

### 题意

每次修改一个格子的状态（是否可用）并询问整个图中阶梯的个数。

### 分析

由于阶梯形状固定，可以将每一个极大的阶梯存下。

发现形状是类似这样的（橙色为红黄共有）：

![](https://cdn.luogu.com.cn/upload/image_hosting/vmecnv52.png)

而每一个长度 $\geqslant2$ 的阶梯都为 有且仅有一个 极大的阶梯 的子阶梯。

对于一个极大的阶梯来说，有一些格子是被禁止的，这些禁止格子将这个阶梯拆成几段。

![](https://cdn.luogu.com.cn/upload/image_hosting/0w6j3rfn.png)

如图，红色被禁止的格子将这两条极大阶梯分别断成了三段。

于是……

### 算法

首先有一个性质：

如果一个阶梯中没有禁止的格子，则此阶梯的 长度 $\geqslant 2$ 的子阶梯的个数为：

$$\begin{pmatrix}len\\2\end{pmatrix}$$

其中 $len$ 为此阶梯的长度。

#### init

对每个极大阶梯计算上述式子并求和即可。

#### modify

**若将 $(x,y)$ 由可用转禁止：**

由于任意一个位置属于两个极大阶梯（这里规定左下角和右上角单独的位置也算极大），将这两个极大阶梯分别进行变化值的计算，即可。

变化值的计算：

极大阶梯中“左上”看作“前”，“右下”看作“后”，记录 $(x,y)$ 在此阶梯中前后第一个遇到的禁止格，记为 $pre$ 和 $suc$。

$e.g.$

![](https://cdn.luogu.com.cn/upload/image_hosting/jon6nfpy.png)

此时将 $(x,y)$ 转禁止，损失为**起点在 $(pre,(x,y)]$，终点在 $[(x,y),suc)$ 这些此极大阶梯的子阶梯**。

乘法原理计算即可。

**若将 $(x,y)$ 由禁止转可用：**

即为上面的逆过程，不再赘述。

### Code

细节较多，每次不要忘了考虑那些长度为 $1$ 的阶梯。

代码不到 $50$ 行。

时间复杂度 $O(n+m+q\log n)$。

[Code Link](https://codeforces.com/contest/1598/submission/132008407)