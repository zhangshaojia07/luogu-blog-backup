# CF1660F2 Promising String (hard version)

### Preface

但是你的愿望是 AK Div.3……

### Analysis

我们把 `'+'` 看作 $1$，把 `'-'` 看作 $-1$，作前缀和 $a_0(=0),a_1,a_2,\dots,a_n$。

发现**一个子串 $(l,r]$（左开右闭）是「Promising」的当且仅当**

$$\begin{cases}
a_r-a_l\le 0&(1)
\\
a_r-a_l\equiv 0 \pmod{3}&(2)
\\
\text{calc}(l,r)\ge 0 &(3)
\end{cases}$$

$(1)$ 解释：原来 `'-'` 必须不少于 `'+'`。

$(2)$ 解释：两个 `'-'` 可以变成一个 `'+'`，所以最后总和只能增加 $3$ 的倍数。

$(3)$ 解释：$\text{calc}(l,r)$ 表示子串 $(l,r]$ 内进行「两减变一加」操作（可多次）后 $a_r'-a_l'$ 的最大值。显然必须 $\ge 0$，否则减号永远比加号多。

至此，我们 $O(n^2)$ 解决了 F1，看一下[代码](https://codeforces.com/contest/1660/submission/152282414)吧。

然后需要发现一个……

------------

**结论：**

若 $(1),(2)$ 条件均满足，$(3)$ 必然满足。

**证明：**

假设存在不满足 $(3)$ 但满足 $(1),(2)$ 的子串 $a_{l+1},a_{l+2},\dots,a_r$。将其 $\text{calc}$ 后为序列 $\{b\}$（长度不一定为 $r-l$），得到 $\sum b_i<0$ 且 $\{b\}$ 中没有两个相邻的 `'-'`。则 $\{b\}$ 一定为 $\{-,+,-,+,\dots,+,-,+,-\}$。此时即得到 $a(l,r]$ 不满足 $(2)$，矛盾。假设不成立，原命题得证。

------------

然后问题就是求满足

$$\begin{cases}
0\le l<r\le n
\\
a_l\ge a_r &(1)
\\
a_l\equiv a_r \pmod{3} &(2)
\end{cases}$$

的二元组 $(l,r)$ 个数。

**同余分组后求逆序对数**即可（**树状数组** 或 **分治** 均可）

时间 $O(n\log n)$

### Code

[F2 的树状数组代码](https://codeforces.com/contest/1660/submission/152282515)