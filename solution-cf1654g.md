# CF1654G Snowy Mountain（分层 BFS+换根 DP）

~~正解 $O(n\sqrt{n})$，谁又想得到呢？~~

首先一次 BFS 求出每个节点的高度。

贪心地，一个位置上若要滑得最远，可以先不断滑，然后到达两个相邻且高度相同的节点反复横跳，将势能用尽后再滑向底部。

记 $h_i$ 表示 $i$ 点的高度，若出发节点为 $x$，反复横跳的节点为 $y$，则最终滑雪距离为
$$
Ans=2h_x-h_y
$$
所以我们对于每一个出发点，需要找到最小的反复横跳高度。

记那些可以反复横跳的节点为集合 $P$。

* * *

**结论：** $P$ 中不同的高度数量为 $O(\sqrt{n})$。

* * *

所以我们对于每种 $P$ 内出现的高度，求出哪些点可以在这个高度反复横跳，设当前考虑高度 $v$。

记 $f_i$ 表示在 $i$ 节点至少要储备多少势能才能到达 $v$ 高度横跳，转移有
$$
f_x=0\quad(h_x=v)
$$
$$
f_i=\min\{\max(0,f_j-1)\ |\ (i,j)\in E,h_i=h_j+1\}\cup\{f_j+1\ |\ (i,j)\in E,h_i=h_j\}
$$
前半部分我们按 $h$ 分层 BFS，后半部分换根树形 DP。

代码实现要达到 $O(n\sqrt n)$ 且不写假或带 $\log$ 是挺麻烦的。

[更多 STL 的代码](https://codeforces.com/contest/1654/submission/164142890) [更少 STL 的代码](https://codeforces.com/contest/1654/submission/164144640)